{% extends 'base.html.twig' %}

{% block title %}Nouvelle location{% endblock %}

{% block breadcrumbs %}
    <nav aria-label="breadcrumb" class="breadcrumb-nav mb-3">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a href="{{ path('app_dashboard') }}">Tableau de bord</a></li>
            <li class="breadcrumb-item"><a href="{{ path('app_location_index') }}">Locations</a></li>
            <li class="breadcrumb-item active" aria-current="page">Nouvelle location</li>
        </ol>
    </nav>
{% endblock %}

{% block body %}
<div class="page-header">
    <h1 class="page-title">Nouvelle location</h1>
    <p class="page-description">Créez une nouvelle location en 3 étapes</p>
</div>

<ul class="reservation-stepper mb-4" id="reservationStepper">
    <li class="step active" data-step="1">
        <span class="step-num">1</span>
        <span class="step-label">Face & Client</span>
    </li>
    <li class="step" data-step="2">
        <span class="step-num">2</span>
        <span class="step-label">Dates & Durée</span>
    </li>
    <li class="step" data-step="3">
        <span class="step-num">3</span>
        <span class="step-label">Montant & Confirmation</span>
    </li>
</ul>

<div class="row g-3 g-lg-4">
    <div class="col-lg-8">
        <div class="section-card">
            <div class="section-header">
                <h3 class="section-title"><i class="bi bi-plus-circle"></i> Informations de la location</h3>
            </div>
            <div class="form-card-inner">
                {% include 'location/_alerts.html.twig' with { face_obj: face_obj|default(null), client_obj: client_obj|default(null), form: form } %}
                {% include 'location/_form.html.twig' with { form: form } %}
            </div>
        </div>
    </div>
    {% include 'location/_sidebar.html.twig' with { face_id: face_id|default(null), face_obj: face_obj|default(null), client_id: client_id|default(null), client_obj: client_obj|default(null) } %}
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const faceSelect = document.getElementById('location_face');
    const montantInput = document.getElementById('location_montantMensuel');
    const notesSelect = document.getElementById('location_notes');
    const dateDebutInput = document.getElementById('location_dateDebut');
    const dureeMoisInput = document.getElementById('location_dureeMois');
    const dateFinInput = document.getElementById('location_dateFin');
    const confirmerMauvaisCheckbox = document.getElementById('location_confirmerEtatMauvais');

    var currentStep = 1;
    var totalSteps = 3;

    function showStep(step) {
        currentStep = step;
        document.querySelectorAll('.step-content').forEach(function(el) {
            el.style.display = el.dataset.step == step ? 'block' : 'none';
        });
        document.querySelectorAll('#reservationStepper .step').forEach(function(el) {
            var n = parseInt(el.dataset.step, 10);
            el.classList.remove('active', 'completed');
            if (n === step) el.classList.add('active');
            else if (n < step) el.classList.add('completed');
        });
        document.getElementById('stepPrevBtn').style.display = step === 1 ? 'none' : 'inline-flex';
        document.getElementById('stepNextBtn').style.display = step === totalSteps ? 'none' : 'inline-flex';
        document.getElementById('stepSubmitBtn').style.display = step === totalSteps ? 'inline-flex' : 'none';
    }

    document.getElementById('stepNextBtn').addEventListener('click', function() {
        if (currentStep < totalSteps) showStep(currentStep + 1);
    });
    document.getElementById('stepPrevBtn').addEventListener('click', function() {
        if (currentStep > 1) showStep(currentStep - 1);
    });

    function formatNumber(n) {
        return Number(n).toLocaleString('fr-FR');
    }

    function updateCostPreview() {
        var mensuel = 0;
        if (montantInput && montantInput.value) {
            mensuel = parseFloat(String(montantInput.value).replace(/\s/g, '').replace(/,/g, '.')) || 0;
        }
        var duree = 0;
        if (dureeMoisInput && dureeMoisInput.value) {
            duree = parseInt(dureeMoisInput.value, 10) || 0;
        }
        var dateFinStr = '—';
        if (dateFinInput && dateFinInput.value) {
            var d = new Date(dateFinInput.value);
            dateFinStr = d.toLocaleDateString('fr-FR');
        }
        document.getElementById('preview-mensuel').textContent = mensuel > 0 ? formatNumber(mensuel) + ' FCFA' : '—';
        document.getElementById('preview-duree').textContent = duree > 0 ? duree + ' mois' : '—';
        document.getElementById('preview-datefin').textContent = dateFinStr;
        var total = mensuel * duree;
        document.getElementById('preview-total').textContent = total > 0 ? formatNumber(total) + ' FCFA' : '— FCFA';
    }

    if (montantInput) montantInput.addEventListener('input', updateCostPreview);
    if (dureeMoisInput) dureeMoisInput.addEventListener('input', updateCostPreview);
    if (dateFinInput) dateFinInput.addEventListener('change', updateCostPreview);
    setInterval(updateCostPreview, 500);

    if (faceSelect && confirmerMauvaisCheckbox) {
        function toggleConfirmerMauvais() {
            var opt = faceSelect.options[faceSelect.selectedIndex];
            var etat = opt ? opt.getAttribute('data-etat') : '';
            var wrapper = confirmerMauvaisCheckbox ? confirmerMauvaisCheckbox.closest('.mb-3') : null;
            if (wrapper) wrapper.style.display = etat === 'mauvais' ? 'block' : 'none';
            if (etat !== 'mauvais') confirmerMauvaisCheckbox.checked = false;
        }
        faceSelect.addEventListener('change', toggleConfirmerMauvais);
        toggleConfirmerMauvais();
    }

    if (faceSelect && montantInput && notesSelect) {
        var prixOriginal = null;
        function chargerPrixFace(faceId) {
            if (!faceId || montantInput.dataset.manualEdit === 'true') return;
            fetch('/location/get-prix-face/' + faceId)
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (data.prix) {
                        var p = Math.round(parseFloat(data.prix));
                        montantInput.value = p;
                        montantInput.dataset.prixOriginal = p;
                        prixOriginal = p;
                        verifierModificationPrix();
                        updateCostPreview();
                    }
                })
                .catch(function() {});
        }
        function verifierModificationPrix() {
            if (montantInput.dataset.prixOriginal) prixOriginal = parseFloat(montantInput.dataset.prixOriginal);
            if (!prixOriginal) return;
            var actuel = parseFloat(String(montantInput.value).replace(/\s/g, '').replace(/,/g, '.')) || 0;
            var diff = Math.abs(actuel - prixOriginal);
            if (diff > 0.01 && actuel > 0) {
                notesSelect.disabled = false;
                notesSelect.setAttribute('required', 'required');
            } else {
                notesSelect.disabled = true;
                notesSelect.value = '';
                notesSelect.removeAttribute('required');
            }
        }
        setTimeout(function() {
            if (faceSelect.value) chargerPrixFace(faceSelect.value);
            verifierModificationPrix();
        }, 300);
        faceSelect.addEventListener('change', function() {
            montantInput.dataset.manualEdit = 'false';
            if (faceSelect.value) chargerPrixFace(faceSelect.value);
        });
        montantInput.addEventListener('input', function() {
            this.dataset.manualEdit = 'true';
            verifierModificationPrix();
        });
    }

    if (dateDebutInput && dureeMoisInput && dateFinInput) {
        function calculerDateFin() {
            var dateDebut = dateDebutInput.value;
            var dureeMois = parseInt(dureeMoisInput.value, 10) || 0;
            if (dateDebut && dureeMois > 0) {
                var date = new Date(dateDebut);
                date.setMonth(date.getMonth() + dureeMois);
                var y = date.getFullYear(), m = String(date.getMonth() + 1).padStart(2, '0'), d = String(date.getDate()).padStart(2, '0');
                dateFinInput.value = y + '-' + m + '-' + d;
                dateFinInput.setAttribute('readonly', 'readonly');
            } else {
                dateFinInput.value = '';
            }
            updateCostPreview();
        }
        dateDebutInput.addEventListener('change', calculerDateFin);
        dureeMoisInput.addEventListener('input', calculerDateFin);
        dateFinInput.addEventListener('focus', function(e) { e.preventDefault(); this.blur(); });
        dateFinInput.addEventListener('keydown', function(e) { e.preventDefault(); });
        dateFinInput.addEventListener('click', function(e) { e.preventDefault(); this.blur(); });
        setTimeout(function() {
            if (dateDebutInput.value && dureeMoisInput.value) calculerDateFin();
        }, 100);
    }

    var blockDispo = document.getElementById('disponibilite-face-block');
    var contentDispo = document.getElementById('disponibilite-face-content');
    if (faceSelect && blockDispo && contentDispo) {
        faceSelect.addEventListener('change', function() {
            var faceId = faceSelect.value;
            if (!faceId) {
                blockDispo.style.display = 'none';
                return;
            }
            fetch('/location/face/' + faceId + '/disponibilite')
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (data.periodes && data.periodes.length > 0) {
                        blockDispo.style.display = 'block';
                        contentDispo.innerHTML = 'Périodes déjà réservées :<br>' + data.periodes.map(function(p) {
                            return p.start + ' → ' + p.end + (p.client ? ' (' + p.client + ')' : '');
                        }).join('<br>');
                    } else {
                        blockDispo.style.display = 'block';
                        contentDispo.innerHTML = '<i class="bi bi-check-circle text-success"></i> Aucune réservation future. Face disponible.';
                    }
                })
                .catch(function() {
                    blockDispo.style.display = 'none';
                });
        });
        if (faceSelect.value) faceSelect.dispatchEvent(new Event('change'));
    }

    updateCostPreview();
});
</script>
{% endblock %}
