{% extends 'base.html.twig' %}

{% block title %}Modifier location{% endblock %}

{% block body %}
<div class="page-header">
    <h1 class="page-title">Modifier location</h1>
    <p class="page-description">Modifiez les informations de la location</p>
</div>

<div class="row">
    <div class="col-md-8 offset-md-2">
        <div class="section-card">
            <div class="section-header">
                <h3 class="section-title"><i class="bi bi-pencil"></i> Informations de la location</h3>
            </div>
            <div>
                {{ form_start(form) }}
                    {{ form_row(form.face) }}
                    {{ form_row(form.client) }}
                    <div class="row">
                        <div class="col-md-6">
                            {{ form_row(form.dateDebut) }}
                        </div>
                        <div class="col-md-6">
                            {{ form_row(form.dureeMois) }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            {{ form_row(form.dateFin) }}
                        </div>
                    </div>
                    {{ form_row(form.montantMensuel) }}
                    {{ form_row(form.notes) }}

                    <div id="confirmer-mauvais-wrapper" class="mb-3" {% if not (location.face and location.face.etat == 'mauvais') %}style="display: none;"{% endif %}>
                        <div class="alert alert-warning mb-2">
                            <i class="bi bi-exclamation-triangle"></i> Ce panneau est en état dégradé. Souhaitez-vous quand même le louer ?
                        </div>
                        {{ form_row(form.confirmerEtatMauvais) }}
                    </div>

                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> Le montant mensuel peut être modifié pour appliquer une remise ou un tarif spécial.
                        <br>
                        <i class="bi bi-info-circle"></i> Le système vérifiera automatiquement que la face est disponible pour la période sélectionnée.
                    </div>

                    <div style="display: flex; justify-content: space-between; margin-top: 2rem;">
                        <a href="{{ path('app_location_index') }}" class="btn-secondary-modern">
                            <i class="bi bi-arrow-left"></i> Retour
                        </a>
                        <button type="submit" class="btn-primary-modern">
                            <i class="bi bi-check"></i> Enregistrer
                        </button>
                    </div>
                {{ form_end(form) }}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const faceSelect = document.getElementById('location_face');
    const montantInput = document.getElementById('location_montantMensuel');
    const notesSelect = document.getElementById('location_notes');
    const dateDebutInput = document.getElementById('location_dateDebut');
    const dureeMoisInput = document.getElementById('location_dureeMois');
    const dateFinInput = document.getElementById('location_dateFin');

    if (faceSelect && montantInput && notesSelect) {
        // Désactiver la justification tant que le prix n'est pas modifié
        notesSelect.disabled = true;

        let prixOriginal = null;

        // Fonction pour récupérer le prix du panneau
        function getPrixPanneau(faceId) {
            return fetch(`/location/get-prix-face/${faceId}`)
                .then(response => response.json())
                .then(data => parseFloat(data.prix) || 0)
                .catch(() => 0);
        }

        // Vérifier si le prix a été modifié et activer/désactiver la justification
        async function verifierModificationPrix() {
            if (!prixOriginal && faceSelect.value) {
                prixOriginal = await getPrixPanneau(faceSelect.value);
                if (!prixOriginal && montantInput.dataset.prixOriginal) {
                    prixOriginal = parseFloat(montantInput.dataset.prixOriginal);
                }
            }

            if (prixOriginal) {
                const prixActuelStr = montantInput.value.toString()
                    .replace(/\s/g, '')
                    .replace(/,/g, '.')
                    .replace(/[^\d.]/g, '');
                const prixActuel = parseFloat(prixActuelStr) || 0;
                const difference = Math.abs(prixActuel - prixOriginal);

                if (difference > 0.01 && prixActuel > 0) {
                    // Prix modifié : activer et exiger une justification
                    notesSelect.disabled = false;
                    notesSelect.setAttribute('required', 'required');
                    notesSelect.classList.add('is-invalid');

                    const formGroup = notesSelect.closest('.mb-3');
                    if (formGroup) {
                        let helpText = formGroup.querySelector('.form-text.text-danger');
                        if (!helpText) {
                            helpText = document.createElement('div');
                            helpText.className = 'form-text text-danger';
                            formGroup.appendChild(helpText);
                        }
                        helpText.textContent = 'Ce champ est obligatoire car le prix a été modifié.';
                    }
                } else {
                    // Prix identique : désactiver et vider la justification
                    notesSelect.disabled = true;
                    notesSelect.removeAttribute('required');
                    notesSelect.classList.remove('is-invalid');
                    notesSelect.value = '';

                    const formGroup = notesSelect.closest('.mb-3');
                    if (formGroup) {
                        const helpText = formGroup.querySelector('.form-text.text-danger');
                        if (helpText) {
                            helpText.remove();
                        }
                    }
                }
            }
        }

        // Initialiser le prix original
        if (faceSelect.value) {
            getPrixPanneau(faceSelect.value).then(prix => {
                prixOriginal = prix;
                montantInput.dataset.prixOriginal = prix;
                verifierModificationPrix();
            });
        } else if (montantInput.value) {
            let valeurActuelle = montantInput.value.toString()
                .replace(/\s/g, '')
                .replace(/,/g, '.')
                .replace(/[^\d.]/g, '');
            prixOriginal = parseFloat(valeurActuelle) || 0;
            if (prixOriginal > 0) {
                montantInput.dataset.prixOriginal = prixOriginal;
                verifierModificationPrix();
            }
        }

        // Écouter les changements de sélection de face
        faceSelect.addEventListener('change', function() {
            if (this.value) {
                getPrixPanneau(this.value).then(prix => {
                    prixOriginal = prix;
                    montantInput.dataset.prixOriginal = prix;
                    verifierModificationPrix();
                });
            }
        });

        // Écouter les changements du montant
        montantInput.addEventListener('input', function() {
            verifierModificationPrix();
        });

        // Vérifier au chargement
        setTimeout(() => verifierModificationPrix(), 500);
    }

    // Calcul automatique de la date de fin
    if (dateDebutInput && dureeMoisInput && dateFinInput) {
        // Calculer la durée initiale à partir des dates existantes
        function calculerDureeInitiale() {
            if (dateDebutInput.value && dateFinInput.value && !dureeMoisInput.value) {
                const dateDebut = new Date(dateDebutInput.value);
                const dateFin = new Date(dateFinInput.value);

                const diffTime = Math.abs(dateFin - dateDebut);
                const diffMonths = Math.round(diffTime / (1000 * 60 * 60 * 24 * 30.44));

                if (diffMonths > 0) {
                    dureeMoisInput.value = diffMonths;
                }
            }
        }

        function calculerDateFin() {
            const dateDebut = dateDebutInput.value;
            const dureeMois = parseInt(dureeMoisInput.value) || 0;

            if (dateDebut && dureeMois > 0) {
                const date = new Date(dateDebut);
                date.setMonth(date.getMonth() + dureeMois);

                const annee = date.getFullYear();
                const mois = String(date.getMonth() + 1).padStart(2, '0');
                const jour = String(date.getDate()).padStart(2, '0');
                const dateFinFormatee = `${annee}-${mois}-${jour}`;

                dateFinInput.value = dateFinFormatee;
                dateFinInput.setAttribute('readonly', 'readonly');
                dateFinInput.dataset.autoCalculated = 'true';
            } else {
                dateFinInput.setAttribute('readonly', 'readonly');
            }
        }

        setTimeout(() => {
            calculerDureeInitiale();
        }, 100);

        dateDebutInput.addEventListener('change', function() {
            calculerDateFin();
        });

        dureeMoisInput.addEventListener('input', function() {
            calculerDateFin();
        });

        // Empêcher la modification manuelle de la date de fin
        dateFinInput.addEventListener('focus', function(e) {
            e.preventDefault();
            this.blur();
        });
        dateFinInput.addEventListener('keydown', function(e) {
            e.preventDefault();
        });
        dateFinInput.addEventListener('click', function(e) {
            e.preventDefault();
            this.blur();
        });
    }
});
</script>
{% endblock %}

