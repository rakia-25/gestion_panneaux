{% extends 'base.html.twig' %}

{% block title %}Modifier LOC-{{ "%03d"|format(location.id) }}{% endblock %}

{% block breadcrumbs %}
    <nav aria-label="breadcrumb" class="breadcrumb-nav mb-3">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a href="{{ path('app_dashboard') }}">Tableau de bord</a></li>
            <li class="breadcrumb-item"><a href="{{ path('app_location_index') }}">Locations</a></li>
            <li class="breadcrumb-item"><a href="{{ path('app_location_show', { id: location.id }) }}">LOC-{{ "%03d"|format(location.id) }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">Modifier</li>
        </ol>
    </nav>
{% endblock %}

{% block body %}
<div class="page-header d-flex flex-wrap justify-content-between align-items-start gap-2">
    <div>
        <h1 class="page-title">Modifier LOC-{{ "%03d"|format(location.id) }}</h1>
        <p class="page-description">{{ location.face.nomComplet }} — {{ location.client.nom }}</p>
    </div>
    <a href="{{ path('app_location_show', { id: location.id }) }}" class="btn-secondary-modern">
        <i class="bi bi-arrow-left"></i> Retour à la fiche
    </a>
</div>

<div class="row g-3 g-lg-4">
    <div class="col-lg-8">
        <div class="section-card">
            <div class="section-header">
                <h3 class="section-title mb-0"><i class="bi bi-pencil"></i> Informations de la location</h3>
            </div>
            <div class="form-card-inner">
                {% include 'location/_form.html.twig' with {
                    form: form,
                    edit_mode: true,
                    location: location,
                    cancel_path: path('app_location_show', { id: location.id })
                } %}
            </div>
        </div>
    </div>
    {% include 'location/_sidebar.html.twig' with { edit_mode: true, location: location } %}
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const faceSelect = document.getElementById('location_face');
    const montantInput = document.getElementById('location_montantMensuel');
    const notesSelect = document.getElementById('location_notes');
    const dateDebutInput = document.getElementById('location_dateDebut');
    const dureeMoisInput = document.getElementById('location_dureeMois');
    const dateFinInput = document.getElementById('location_dateFin');

    if (faceSelect && montantInput && notesSelect) {
        notesSelect.disabled = true;
        let prixOriginal = null;

        function getPrixPanneau(faceId) {
            return fetch(`/location/get-prix-face/${faceId}`)
                .then(response => response.json())
                .then(data => parseFloat(data.prix) || 0)
                .catch(() => 0);
        }

        async function verifierModificationPrix() {
            if (!prixOriginal && faceSelect.value) {
                prixOriginal = await getPrixPanneau(faceSelect.value);
                if (!prixOriginal && montantInput.dataset.prixOriginal) {
                    prixOriginal = parseFloat(montantInput.dataset.prixOriginal);
                }
            }
            if (prixOriginal) {
                const prixActuelStr = montantInput.value.toString()
                    .replace(/\s/g, '')
                    .replace(/,/g, '.')
                    .replace(/[^\d.]/g, '');
                const prixActuel = parseFloat(prixActuelStr) || 0;
                const difference = Math.abs(prixActuel - prixOriginal);
                if (difference > 0.01 && prixActuel > 0) {
                    notesSelect.disabled = false;
                    notesSelect.setAttribute('required', 'required');
                    notesSelect.classList.add('is-invalid');
                    const formGroup = notesSelect.closest('.mb-3');
                    if (formGroup) {
                        let helpText = formGroup.querySelector('.form-text.text-danger');
                        if (!helpText) {
                            helpText = document.createElement('div');
                            helpText.className = 'form-text text-danger';
                            formGroup.appendChild(helpText);
                        }
                        helpText.textContent = 'Ce champ est obligatoire car le prix a été modifié.';
                    }
                } else {
                    notesSelect.disabled = true;
                    notesSelect.removeAttribute('required');
                    notesSelect.classList.remove('is-invalid');
                    notesSelect.value = '';
                    const formGroup = notesSelect.closest('.mb-3');
                    if (formGroup) {
                        const helpText = formGroup.querySelector('.form-text.text-danger');
                        if (helpText) helpText.remove();
                    }
                }
            }
        }

        if (faceSelect.value) {
            getPrixPanneau(faceSelect.value).then(prix => {
                prixOriginal = prix;
                montantInput.dataset.prixOriginal = prix;
                verifierModificationPrix();
            });
        } else if (montantInput.value) {
            let valeurActuelle = montantInput.value.toString()
                .replace(/\s/g, '')
                .replace(/,/g, '.')
                .replace(/[^\d.]/g, '');
            prixOriginal = parseFloat(valeurActuelle) || 0;
            if (prixOriginal > 0) {
                montantInput.dataset.prixOriginal = prixOriginal;
                verifierModificationPrix();
            }
        }

        faceSelect.addEventListener('change', function() {
            if (this.value) {
                getPrixPanneau(this.value).then(prix => {
                    prixOriginal = prix;
                    montantInput.dataset.prixOriginal = prix;
                    verifierModificationPrix();
                });
            }
        });
        montantInput.addEventListener('input', function() { verifierModificationPrix(); });
        setTimeout(() => verifierModificationPrix(), 500);
    }

    if (dateDebutInput && dureeMoisInput && dateFinInput) {
        function calculerDureeInitiale() {
            if (dateDebutInput.value && dateFinInput.value && !dureeMoisInput.value) {
                const dateDebut = new Date(dateDebutInput.value);
                const dateFin = new Date(dateFinInput.value);
                const diffTime = Math.abs(dateFin - dateDebut);
                const diffMonths = Math.round(diffTime / (1000 * 60 * 60 * 24 * 30.44));
                if (diffMonths > 0) dureeMoisInput.value = diffMonths;
            }
        }
        function calculerDateFin() {
            const dateDebut = dateDebutInput.value;
            const dureeMois = parseInt(dureeMoisInput.value) || 0;
            if (dateDebut && dureeMois > 0) {
                const date = new Date(dateDebut);
                date.setMonth(date.getMonth() + dureeMois);
                const annee = date.getFullYear();
                const mois = String(date.getMonth() + 1).padStart(2, '0');
                const jour = String(date.getDate()).padStart(2, '0');
                dateFinInput.value = `${annee}-${mois}-${jour}`;
                dateFinInput.setAttribute('readonly', 'readonly');
                dateFinInput.dataset.autoCalculated = 'true';
            } else {
                dateFinInput.setAttribute('readonly', 'readonly');
            }
        }
        setTimeout(() => calculerDureeInitiale(), 100);
        dateDebutInput.addEventListener('change', calculerDateFin);
        dureeMoisInput.addEventListener('input', calculerDateFin);
        dateFinInput.addEventListener('focus', function(e) { e.preventDefault(); this.blur(); });
        dateFinInput.addEventListener('keydown', function(e) { e.preventDefault(); });
        dateFinInput.addEventListener('click', function(e) { e.preventDefault(); this.blur(); });
    }

    function updateCostPreview() {
        var mensuel = 0;
        if (montantInput && montantInput.value) {
            mensuel = parseFloat(String(montantInput.value).replace(/\s/g, '').replace(/,/g, '.')) || 0;
        }
        var duree = 0;
        if (dureeMoisInput && dureeMoisInput.value) {
            duree = parseInt(dureeMoisInput.value, 10) || 0;
        }
        var dateFinStr = '—';
        if (dateFinInput && dateFinInput.value) {
            var d = new Date(dateFinInput.value);
            dateFinStr = d.toLocaleDateString('fr-FR');
        }
        var total = mensuel * duree;
        var previewMensuel = document.getElementById('preview-mensuel');
        var previewDuree = document.getElementById('preview-duree');
        var previewDatefin = document.getElementById('preview-datefin');
        var previewTotal = document.getElementById('preview-total');
        if (previewMensuel) previewMensuel.textContent = mensuel > 0 ? mensuel.toLocaleString('fr-FR') + ' FCFA' : '—';
        if (previewDuree) previewDuree.textContent = duree > 0 ? duree + ' mois' : '—';
        if (previewDatefin) previewDatefin.textContent = dateFinStr;
        if (previewTotal) previewTotal.textContent = total > 0 ? total.toLocaleString('fr-FR') + ' FCFA' : '— FCFA';
    }
    if (montantInput) montantInput.addEventListener('input', updateCostPreview);
    if (dureeMoisInput) dureeMoisInput.addEventListener('input', updateCostPreview);
    if (dateFinInput) dateFinInput.addEventListener('change', updateCostPreview);
    setTimeout(updateCostPreview, 300);
});
</script>
{% endblock %}
