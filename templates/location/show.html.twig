{% extends 'base.html.twig' %}

{% block title %}Location #{{ location.id }}{% endblock %}

{% block body %}
<div class="page-header">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1 class="page-title">Location #{{ location.id }}</h1>
            <p class="page-description">{{ location.face.nomComplet }} - {{ location.client.nom }}</p>
        </div>
        <div style="display: flex; gap: 0.75rem;">
            {% if not location.isAnnulee %}
                <a href="{{ path('app_location_edit', {id: location.id}) }}" class="btn-secondary-modern">
                    <i class="bi bi-pencil"></i> Modifier
                </a>
                <a href="{{ path('app_location_annuler', {id: location.id}) }}" class="btn-danger-modern">
                    <i class="bi bi-x-circle"></i> Annuler
                </a>
            {% endif %}
            <a href="{{ path('app_location_index') }}" class="btn-secondary-modern">
                <i class="bi bi-arrow-left"></i> Retour
            </a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="section-card" style="margin-bottom: 1.5rem;">
            <div class="section-header">
                <h3 class="section-title">Informations de la location</h3>
            </div>
            <table class="modern-table" style="margin: 0;">
                <tbody>
                    <tr>
                        <th width="200" style="font-weight: 600; color: var(--text-gray);">Face</th>
                        <td>
                            <strong>{{ location.face.nomComplet }}</strong><br>
                            <small style="color: var(--text-gray); font-size: 0.75rem;">{{ location.face.panneau.emplacement }}</small>
                        </td>
                    </tr>
                    <tr>
                        <th>Client</th>
                        <td>
                            <strong>{{ location.client.nom }}</strong><br>
                            {% if location.client.email %}
                                <small style="color: var(--text-gray); font-size: 0.75rem;">{{ location.client.email }}</small>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th>Période</th>
                        <td>
                            <strong>{{ location.dateDebut|date('d/m/Y') }}</strong> -
                            <strong>{{ location.dateFin|date('d/m/Y') }}</strong><br>
                            <small style="color: var(--text-gray); font-size: 0.75rem;">{{ location.nombreMois }} mois</small>
                        </td>
                    </tr>
                    <tr>
                        <th>Montant mensuel</th>
                        <td><strong>{{ location.montantMensuel|number_format(0, ',', ' ') }} FCFA</strong></td>
                    </tr>
                    <tr>
                        <th>Montant total</th>
                        <td><strong style="color: var(--primary-color); font-size: 1.25rem;">{{ location.montantTotal|number_format(0, ',', ' ') }} FCFA</strong></td>
                    </tr>
                    <tr>
                        <th>Statut de paiement</th>
                        <td>
                            {% set statutPaiement = location.statutPaiement %}
                            {% if statutPaiement == 'paye' %}
                                <span class="table-badge success" style="font-size: 0.875rem;">Payé</span>
                            {% elseif statutPaiement == 'partiellement_paye' %}
                                <span class="table-badge warning" style="font-size: 0.875rem;">Partiellement payé</span>
                            {% else %}
                                <span class="table-badge pending" style="font-size: 0.875rem;">Impayé</span>
                            {% endif %}
                            <br>
                            <small style="color: var(--text-gray); margin-top: 0.5rem; display: block;">
                                Payé: <strong>{{ location.montantTotalPaye|number_format(0, ',', ' ') }} FCFA</strong> |
                                Restant: <strong>{{ location.montantRestant|number_format(0, ',', ' ') }} FCFA</strong>
                            </small>
                        </td>
                    </tr>
                    <tr>
                        <th>Montant payé</th>
                        <td><strong style="color: var(--success-color);">{{ location.montantTotalPaye|number_format(0, ',', ' ') }} FCFA</strong></td>
                    </tr>
                    <tr>
                        <th>Montant restant</th>
                        <td><strong style="color: var(--danger-color);">{{ location.montantRestant|number_format(0, ',', ' ') }} FCFA</strong></td>
                    </tr>
                    <tr>
                        <th>Statut</th>
                        <td>
                            {% if location.isAnnulee %}
                                <span class="table-badge danger">Annulée</span>
                                {% if location.dateAnnulation %}
                                    <br><small style="color: var(--text-gray); font-size: 0.75rem;">
                                        Annulée le {{ location.dateAnnulation|date('d/m/Y à H:i') }}
                                        {% if location.raisonAnnulation %}
                                            <br>Raison: {{ location.raisonAnnulation }}
                                        {% endif %}
                                    </small>
                                {% endif %}
                            {% elseif location.isActive() %}
                                <span class="table-badge success">En cours</span>
                            {% elseif location.isTerminee() %}
                                <span class="table-badge warning">Terminée</span>
                            {% else %}
                                <span class="table-badge info">À venir</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% if location.notes %}
                    <tr>
                        <th>Notes</th>
                        <td>{{ location.notes }}</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="col-md-4">
        <div class="section-card" style="margin-bottom: 1.5rem;">
            <div class="section-header">
                <h3 class="section-title">Informations du panneau</h3>
            </div>
            <div>
                <p><strong>Référence:</strong> {{ location.face.panneau.reference }}</p>
                <p><strong>Type:</strong>
                    {% if location.face.panneau.type == 'double' %}
                        <span class="table-badge info">Double</span>
                    {% else %}
                        <span class="table-badge warning">Simple</span>
                    {% endif %}
                </p>
                <p><strong>Taille:</strong> {{ location.face.panneau.taille }}</p>
                <p><strong>Prix mensuel:</strong> {{ location.face.panneau.prixMensuel|number_format(0, ',', ' ') }} FCFA</p>
                <a href="{{ path('app_panneau_show', {id: location.face.panneau.id}) }}" class="btn-secondary-modern" style="width: 100%; margin-top: 1rem;">
                    <i class="bi bi-eye"></i> Voir le panneau
                </a>
            </div>
        </div>

        <div class="section-card" style="margin-bottom: 1.5rem;">
            <div class="section-header">
                <h3 class="section-title">Informations du client</h3>
            </div>
            <div>
                <p><strong>Nom:</strong> {{ location.client.nom }}</p>
                {% if location.client.telephone %}
                    <p><strong>Téléphone:</strong> {{ location.client.telephone }}</p>
                {% endif %}
                {% if location.client.email %}
                    <p><strong>Email:</strong> {{ location.client.email }}</p>
                {% endif %}
                <a href="{{ path('app_client_show', {id: location.client.id}) }}" class="btn-secondary-modern" style="width: 100%; margin-top: 1rem;">
                    <i class="bi bi-eye"></i> Voir le client
                </a>
            </div>
        </div>

        <div class="table-card">
            <div class="table-header">
                <h3 class="table-title">Paiements</h3>
                {% if location.isAnnulee %}
                    <div class="alert alert-warning" style="margin: 0; padding: 0.5rem 1rem; font-size: 0.8125rem;">
                        <i class="bi bi-x-circle"></i> Location annulée - Aucun paiement possible
                    </div>
                {% elseif location.isCompletementPaye %}
                    <div class="alert alert-info" style="margin: 0; padding: 0.5rem 1rem; font-size: 0.8125rem;">
                        <i class="bi bi-check-circle"></i> Location entièrement payée
                    </div>
                {% else %}
                    <a href="{{ path('app_paiement_new', {location_id: location.id}) }}" class="btn-primary-modern" style="padding: 0.5rem 1rem; font-size: 0.8125rem;">
                        <i class="bi bi-plus-circle"></i> Ajouter
                    </a>
                {% endif %}
            </div>
            {% if location.paiements|length > 0 %}
                <table class="modern-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Montant</th>
                            <th>Type</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for paiement in location.paiements %}
                            <tr {% if paiement.isAnnule %}style="opacity: 0.6;"{% endif %}>
                                <td>
                                    {{ paiement.datePaiement|date('d/m/Y') }}
                                    {% if paiement.isAnnule %}
                                        <br><small class="text-danger">(Annulé)</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <strong>{{ paiement.montant|number_format(0, ',', ' ') }} FCFA</strong>
                                    {% if paiement.isAnnule %}
                                        <br><small class="text-danger">Annulé le {{ paiement.dateAnnulation|date('d/m/Y') }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="table-badge {% if paiement.isAnnule %}danger{% else %}info{% endif %}">
                                        {{ paiement.typeLibelle }}
                                    </span>
                                </td>
                                <td>
                                    <div class="action-menu">
                                        <a href="{{ path('app_paiement_show', {id: paiement.id}) }}" class="action-btn" title="Voir">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        {% if not paiement.isAnnule and not location.isAnnulee %}
                                            <a href="{{ path('app_paiement_edit', {id: paiement.id}) }}" class="action-btn" title="Modifier">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                            <a href="{{ path('app_paiement_annuler', {id: paiement.id}) }}" class="action-btn text-danger" title="Annuler">
                                                <i class="bi bi-x-circle"></i>
                                            </a>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr style="background: var(--bg-light);">
                            <th>Total payé</th>
                            <th colspan="3"><strong>{{ location.montantTotalPaye|number_format(0, ',', ' ') }} FCFA</strong></th>
                        </tr>
                    </tfoot>
                </table>
            {% else %}
                <div style="text-align: center; padding: 2rem; color: var(--text-gray);">
                    <i class="bi bi-info-circle"></i> Aucun paiement enregistré pour cette location.
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
